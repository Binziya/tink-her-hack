<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueSense | My Status</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .circle-status {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 8px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
            position: relative;
        }

        .status-allocated {
            border-color: #4ade80;
            color: #166534;
        }

        .status-waiting {
            border-color: #fb923c;
            color: #9a3412;
        }

        .status-done {
            border-color: #60a5fa;
            color: #1e40af;
        }

        .big-text {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .info-card {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
        }

        .notification-banner {
            background: #dcfce7;
            color: #166534;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="status.html" class="active"><i class="fas fa-ticket-alt"></i> My Token</a>
    </nav>

    <div class="container">

        <div id="loading" class="text-center p-4">
            <div class="spinner"
                style="border: 4px solid rgba(0,0,0,0.1); width: 30px; height: 30px; border-radius: 50%; border-left-color: #2563eb; animation: spin 1s linear infinite; margin: 0 auto;">
            </div>
            <p class="mt-2" style="color: #64748b;">Syncing with Clinic...</p>
        </div>

        <div id="status-content" class="hidden">
            <!-- Header Card -->
            <div class="card"
                style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: none; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.01); border-radius: 2rem; padding: 2.5rem; text-align: center; position: relative; overflow: hidden;">
                <div
                    style="position: absolute; top: -50px; left: -50px; width: 150px; height: 150px; background: rgba(37, 99, 235, 0.05); border-radius: 50%;">
                </div>

                <h2 id="queue-name"
                    style="font-size: 1.5rem; color: #1e293b; margin-bottom: 2rem; font-weight: 700; letter-spacing: -0.5px;">
                    --</h2>

                <div class="circle-status" id="status-circle"
                    style="transform: scale(1.1); transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);">
                    <span
                        style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: #64748b; opacity: 0.8;">Token</span>
                    <span class="big-text" id="token-id" style="margin: 0.1rem 0; font-size: 3rem;">--</span>
                    <span id="status-text" style="font-size: 0.8rem; font-weight: 800; letter-spacing: 1px;">--</span>
                </div>

                <!-- Notification -->
                <div id="promo-notification" class="notification-banner hidden"
                    style="margin-top: 2rem; border-radius: 1rem; border: none; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); background: #10b981; color: white; padding: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                    <i class="fas fa-check-circle"></i>
                    <span>Good News! A slot opened up. You have been allocated!</span>
                </div>

                <!-- Slot Info -->
                <div id="slot-details" class="info-card hidden"
                    style="margin-top: 2rem; background: #ffffff; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-radius: 1rem; padding: 1.5rem; text-align: center;">
                    <p style="color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; margin-bottom: 0.5rem;"
                        id="slot-label">APPOINTED SLOT</p>
                    <h3 id="slot-time" style="font-size: 1.5rem; color: #2563eb; font-weight: 800;">--</h3>
                </div>

                <!-- Stats Grid -->
                <div class="grid-2 mt-4">
                    <div class="stat-box"
                        style="background: white; border-radius: 1rem; padding: 1.25rem; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02); text-align: center;">
                        <span class="stat-label"
                            style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 700;">Waitlist</span>
                        <span class="stat-value" id="wait-count"
                            style="color: #ef4444; font-size: 1.5rem; font-weight: 700;">--</span>
                    </div>
                    <div class="stat-box"
                        style="background: white; border-radius: 1rem; padding: 1.25rem; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02); text-align: center;">
                        <span class="stat-label"
                            style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 700;">Active
                            Slots</span>
                        <span class="stat-value" id="alloc-count"
                            style="color: #10b981; font-size: 1.5rem; font-weight: 700;">--</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button onclick="location.href='index.html'" class="btn-secondary"
                        style="flex: 1; border-radius: 1rem; padding: 1rem; background: #fff; border: 1px solid #e2e8f0; font-weight: 600; color: #475569;">
                        <i class="fas fa-home"></i> Home
                    </button>
                    <button id="leave-btn" class="btn-secondary"
                        style="flex: 1; border-radius: 1rem; padding: 1rem; color: #ef4444; border-color: #fca5a5; background: #fff; font-weight: 600;">
                        <i class="fas fa-times-circle"></i> Cancel
                    </button>
                </div>
            </div>

            <div id="no-session" class="hidden text-center card"
                style="padding: 4rem 2rem; border-radius: 2rem; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.05); background: #fff;">
                <div style="font-size: 4rem; color: #e2e8f0; margin-bottom: 1.5rem;"><i class="fas fa-ticket-alt"></i>
                </div>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: #1e293b; font-weight: 700;">No Booking Found
                </h3>
                <p style="color: #64748b; margin-bottom: 2rem;">Secure your place in the clinic queue from the home
                    page.</p>
                <a href="index.html" class="btn-primary"
                    style="padding: 1rem 2.5rem; border-radius: 2rem; font-weight: 600; text-decoration: none; display: inline-block;">Explore
                    Services</a>
            </div>

        </div>

        <script src="script.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const QS = window.QueueSense;
                if (!QS) return;

                let previousStatus = null;

                function update() {
                    const session = QS.getUserSession();
                    if (!session) {
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('status-content').classList.add('hidden');
                        document.getElementById('no-session').classList.remove('hidden');
                        return;
                    }

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('no-session').classList.add('hidden');
                    document.getElementById('status-content').classList.remove('hidden');

                    QS.loadState();

                    // Get Full Object
                    let myToken = null;
                    let stats = null;

                    if (session.doctorId) {
                        const docStats = QS.getDoctorStats(session.doctorId);
                        myToken = docStats.list.find(t => t.id === session.token);
                        stats = {
                            allocated: docStats.list.filter(t => t.status === 'allocated').length,
                            waiting: docStats.list.filter(t => t.status === 'waiting').length,
                            name: "Dr. " + (myToken ? myToken.doctorName : "Doctor")
                        };
                    } else {
                        const qStats = QS.getQueueStats(session.type);
                        myToken = qStats.list.find(t => t.id === session.token);
                        stats = {
                            allocated: 0, // Generic queues don't have allocation logic yet
                            waiting: qStats.list.filter(t => t.status === 'waiting').length,
                            name: session.type.toUpperCase()
                        };
                    }

                    // Render
                    document.getElementById('queue-name').innerText = stats.name;
                    document.getElementById('token-id').innerText = "#" + session.token;
                    document.getElementById('wait-count').innerText = stats.waiting;
                    document.getElementById('alloc-count').innerText = stats.allocated;

                    if (myToken) {
                        const circle = document.getElementById('status-circle');
                        const text = document.getElementById('status-text');
                        const slotSection = document.getElementById('slot-details');

                        circle.className = "circle-status"; // reset

                        if (myToken.status === 'allocated') {
                            circle.classList.add('status-allocated');
                            text.innerText = "ALLOCATED";
                            slotSection.classList.remove('hidden');
                            document.getElementById('slot-label').innerText = "ESTIMATED CONSULTATION";
                            document.getElementById('slot-time').innerText = myToken.estimatedSlot || "Confirmed";

                            // NOTIFICATION LOGIC
                            if (previousStatus === 'waiting' || previousStatus === 'pending') {
                                document.getElementById('promo-notification').classList.remove('hidden');
                            }
                        } else if (myToken.status === 'waiting' || myToken.status === 'pending') {
                            circle.classList.add('status-waiting');
                            text.innerText = "WAITING LIST";
                            slotSection.classList.remove('hidden');
                            document.getElementById('slot-label').innerText = "YOUR POSITION";

                            const waitingList = docStats.list.filter(p => p.status === 'waiting');
                            const position = waitingList.findIndex(p => p.id === myToken.id) + 1;

                            document.getElementById('slot-time').innerHTML = `
                                <div style="font-size: 1.8rem; margin-bottom: 0.2rem; color: #1e293b;">#${position} in Waitlist</div>
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 500;">Status: Standby</div>
                            `;

                            // Inform chance with beautiful badges
                            if (position === 1) {
                                text.innerHTML = "WAITING LIST <br><span style='background: #d1fae5; color: #065f46; font-size: 0.65rem; padding: 0.2rem 0.6rem; border-radius: 1rem; font-weight: 800; text-transform: uppercase; margin-top: 5px; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.05);'>Priority: Next Chance</span>";
                            } else {
                                text.innerHTML = "WAITING LIST <br><span style='background: #f1f5f9; color: #475569; font-size: 0.65rem; padding: 0.2rem 0.6rem; border-radius: 1rem; font-weight: 800; text-transform: uppercase; margin-top: 5px; display: inline-block;'>In Queue</span>";
                            }
                        } else {
                            circle.classList.add('status-done');
                            text.innerText = myToken.status.toUpperCase();
                            slotSection.classList.add('hidden');
                        }

                        previousStatus = myToken.status;
                    }
                }

                document.getElementById('leave-btn').addEventListener('click', () => {
                    const session = QS.getUserSession();
                    if (session && confirm("Are you sure you want to leave the queue? Your token will be cancelled.")) {
                        if (session.doctorId) {
                            QS.leaveQueue(session.doctorId, session.token);
                        } else {
                            QS.clearUserSession();
                        }
                        location.href = 'index.html';
                    }
                });

                update();
                setInterval(update, 3000);
            });
        </script>
</body>

</html>